clear all
close all

%Main


tic
%%%%%%%%%%%%%%%%%%%%%%DATOS%%%%%%%%%%

n=100 ;
theta=linspace(0,1,n);

%------Datos Iniciales---------

 m=1;       %Masa del vehiculo
 g=9.8;     %gravedad en la Tierra
 F_n=m*g;   %Fuerza normal
 mu=1;      %Coeficiente de rozamiento
 W_f=3/4;     %Porcentaje de peso del vehiculo en las ruedas delanteras
 h=theta(2)-theta(1);
 %v_ini=0.3;             %velocidad inicial


 eps=0.05;   %Peso del termino de penalizacion de funcion objetivo

 
 %tol=0.5;  %Tolerancia para el metodo de descenso del gradiente
 %step=1; %Paso del metodo del gradiente
v_ini=0.2;
%----------------------------------


%Variables de estado: %b, a, u_lat

% b=optimvar('b',n);
% a=optimvar('a',n-1);
% u_lon=optimvar('u_lon',n-1);
% u_lat=optimvar('u_lat',n-1);

%b0=0.1*ones(n,1);
%a0=0.1*ones(n-1,1);
%u_lat0=zeros(n-1,1);
u_lon0=ones(n-1,1);
% u_lon0=[7.419760553839522
% 7.386661608737290
% 7.374657710797986
% 7.367853784152731
% 7.363317144689409
% 7.360012607147344
% 7.357466288704355
% 7.355426000878998
% 7.353743405360238
% 7.352324742942523
% 7.351107440132269
% -7.690136882091583
% -9.801235762688044
% -9.802750410148361
% -9.804683672124774
% -9.806768019054958
% -8.790788086217491
% -4.263469417455628
% -0.668061447356163
% 0.462070164513088
% -0.265098989740189
% 0.173087124636192
% -0.098142230101424
% 0.046116342816366
% 0.000074672200598
% -0.046281789661723
% 0.098343693969529
% -0.173378134504578
% 0.265495121269125
% -0.536177497416283
% 0.805352226547287
% 5.516329690433044
% 7.360628258514307
% 7.356959858786452
% 7.354155259490541
% 7.351938528035955
% -8.983720268295635
% -9.802348651710712
% -9.513671387341622
% -6.449262836603103
% -0.776075017592778
% 0.246091392418080
% -0.128531035872550
% 0.045917557613847
% 0.032120622780280
% 1.151867565543328
% 4.845737523186589
% -5.800485580710588
% -0.377045644731975
% 0.186532823668774
% 0.000961221015044
% -0.279856273038658
% 0.547039430609975
% 3.156663250693668
% 7.363024545326151
% 7.359002999499496
% 7.355940216548444
% 7.353550613374012
% 7.351619087744008
% 4.579064801969998
% -9.775727928022949
% -8.161412164288494
% -2.738053904303766
% -0.434362821092660
% 0.221906701655042
% -0.101960169992168
% 0.051803271126798
% -0.025304813463462
% 0.012633043929798
% -0.006242325220098
% 0.003100252588141
% -0.001535339661411
% 0.000760584932094
% -0.000375268337979
% 0.000182794027285
% -0.000084248242298
% 0.000029123933956
% 0.000010899398772
% -0.000056382041230
% 0.000130668018906
% -0.000271884976656
% 0.000552299919811
% -0.001116089084392
% 0.002250200974036
% -0.004543665938091
% 0.009139756739177
% -0.018526096358786
% 0.036997899894083
% -0.076328485114983
% 0.148966203538343
% 0.940963748849814
% 7.011826528192665
% 7.357371844897756
% 7.355734335267226
% 7.354347061416710
% 7.353154159494016
% 7.352114057346147
% 7.351196661884813
% 7.350379578674394];


[linealizado_2]=sis_lin_2(theta,m);AA=linealizado_2; %dim 3N+1×3N+1

[indep,lin_control]=term_indep(theta,m,u_lon0,v_ini); %dim 3N+1×1
uu=linealizado_2\indep;   %dim 3N+1×1

b0=uu(1:n);
a0=uu(n+1:(2*n)-1);
u_lat0=uu(2*n:end);
x0=[b0;a0;u_lon0;u_lat0];


%--------Funcion objetivo----------

obj=@objfunx;    



%-----------------Restricciones:
%Restricciones de igualdad: Ax=b 
 %Restricciones de desigualdad: ||u||<mu*F_N
                               %u_lon<W*mu*F_N
% [c,ceq]=nonlincon(x);
nonlincon = @nlcon;


A = [];
b = [];
Aeq = [];
beq = [];
lb =[];
ub = [];



opts=optimoptions('fmincon', 'MaxFunctionEvaluations',1000000,'MaxIterations',5000,'Algorithm','sqp');

x = fmincon(@objfunx,x0,A,b,Aeq,beq,lb,ub,@nlcon,opts);

[b_th,b_m,a_m,u_lon_m,u_lat_m,vel,vel_lon,acel,acel_lon,acel_lat]=var_estado(x,theta,n,F_n,mu,W_f,v_ini);

optimoptions('fmincon');

obj(x)
toc
